# AIエージェント指示プロンプト仕様

## 1. 概要

このドキュメントは、CodeRabbitコメントフェッチャーによって生成されるAIエージェント指示プロンプトの構造と内容を規定します。このプロンプトは、明確性、構造、有効性の観点から[Claudeのベストプラクティス](https://docs.anthropic.com/claude/docs/prompt-engineering)に完全に準拠するよう設計されています。

プロンプト全体は、GitHub CLIを介して取得されたデータから**機械的に**生成されます。**プロンプト生成プロセス自体にLLMは使用されません。** このプロセスは、生のPRデータを、AIエージェントが容易に解析し、それに基づいて行動できる構造化された形式に変換する、決定論的でルールベースの変換です。

## 2. コア設計原則

- **決定論的な生成**: プロンプトは、LLMベースの分析や要約を一切行わず、純粋に機械的なプロセス（文字列操作、正規表現など）を通じて生成されます。これにより、GitHub APIからの同じ入力が常に全く同じ出力を生成することが保証されます。
- **明確さのための構造化**: プロンプトはMarkdownとXML形式のタグを組み合わせて使用し、異なるセクションや情報の種類を明確に区切ることで、AIエージェントが解析しやすくなっています。
- **ロールベースのペルソナ**: AIエージェントに一貫したシニアソフトウェアエンジニアとしてのペルソナを提供するため、冒頭に静的な`<role>`タグが含まれており、分析と応答のスタイルをガイドします。
- **アクション指向**: プロンプトの主な目的は、CodeRabbitからの生の、実行可能なフィードバックを構造化された方法で提示し、AIエージェントが分析と解決策の生成に集中できるようにすることです。
- **決定論的処理**: メタデータ生成のためにルールベースのアルゴリズムを実装し、検証テンプレートを含みます。

## 3. プロンプトの構造

生成されるプロンプトは、以下のセクションで構成されます。

### 3.1. 静的ヘッダー

このセクションは、AIエージェントにそのペルsoナと分析のための一般的な方法論を提供します。内容は静的で、生成されるすべてのプロンプトに含まれます。

- **`<role>`**: AIエージェントのペルソナ（例：シニアソフトウェアエンジニア）を定義します。
- **`<core_principles>`**: エージェントの作業における中心的な指針をリストアップします。
- **`<analysis_steps>`**: 高度なステップバイステップのアプローチの概要を示します。
- **`<priority_matrix>`**: 優先度レベル（Critical, High, Medium, Low）を基準とともに定義します。
- **`<impact_scope>`**: 影響範囲のレベル（System, Module, Function, Line）を分類します。

### 3.2. 動的コンテキスト

このセクションは、分析対象のプルリクエストの特定のコンテキストを提供します。すべての情報はGitHub CLIの出力から動的に入力されます。

- **`<pull_request_context>`**: PRに関する包括的なメタデータを含みます。
  - `<pr_url>`, `<title>`, `<description>`, `<branch>`, `<author>`
  - `<summary>`: ファイル変更統計（`<files_changed>`, `<lines_added>`, `<lines_deleted>`）。
  - `<technical_context>`: 推定される技術詳細（`<repository_type>`, `<key_technologies>`など）。
  - `<changed_files>`: 変更されたファイルのリスト。
- **`<coderabbit_review_summary>`**: コメントタイプの機械的にカウントされた概要を提供します。
- **`<comment_metadata>`**: レビューからの集約されたメタデータを含みます。
  - `<primary_issues>`: 一般的な問題タイプの要約。
  - `<complexity_level>`: PRの複雑性の評価。
  - `<risk_assessment>`: ルールベースのリスクレベル。
  - `<estimated_resolution_time_hours>`: ルールベースの時間見積もり。

### 3.3. 分析タスクの定義

このセクションは、提供されたデータで何を行うべきか、そして期待される出力形式は何かをAIエージェントに指示します。

- **`# Analysis Task`**: タスクのヘッダー。
- **`<analysis_requirements>`**: 異なるコメントタイプ（`Actionable`, `Outside Diff Range`, `Nitpick`）に対して要求される分析の深さを詳述します。
- **`<output_requirements>`**: AIエージェントの応答が従うべき正確な構造を指定します。これには、問題分析、解決策の提案、優先度評価のセクションが含まれます。

### 3.4. 特別な処理指示

このセクションは、特定の複雑なコメント構造を処理するためのガイドラインを提供します。

- **`# Special Processing Instructions`**: これらの指示のヘッダー。
- **`## 🤖 AI Agent Prompts`**: CodeRabbit自身のAI生成提案を`<ai_agent_analysis>`フォーマットを使用して高度な分析を実行する方法を詳述します。
- **`## 🧵 Thread Context Analysis`**: エージェントにコメントスレッドの完全な履歴を考慮するよう指示します。

### 3.5. 構造化されたコメントブロック

これはプロンプトの中核であり、CodeRabbitコメントの構造化データを含みます。

- **`# CodeRabbit Comments for Analysis`**: コメントのヘッダー。
- **`<review_comments>`**: すべての個別のレビューコメントを含むルートタグ。
- **`<review_comment>`**: CodeRabbitからの単一のフィードバックを表すコンテナ。
  - **`type`属性**: コメントのカテゴリ（`Actionable`, `Nitpick`）。
  - **`file`属性**: ファイルパス。
  - **`lines`属性**: 行番号または範囲。
  - **`<issue_summary>`**: CodeRabbitコメントのタイトルまたは要点。
  - **`<coderabbit_analysis>`**: CodeRabbitコメントの詳細な本文。
  - **`<ai_agent_prompt>`**: 存在する場合、CodeRabbitからのAIエージェント向けの生のプロンプトを含みます。
  - **`<proposed_diff>`**: CodeRabbitからの提案されたコード変更を含むCDATAブロック。

### 3.6. 静的フッター

- **`# Analysis Instructions`**: 決定論的な処理のためのフレームワークを含みます。
  - **`<deterministic_processing_framework>`**: 分類のためのキーワードマッチングを含む、ルールベースの処理ステップの概要を示します。
  - **`<verification_templates>`**: 異なるコメントタイプやビルドシステムに対する特定の検証手順を提供します。

## 4. 生成プロセス

プロンプトは`coderabbit-fetcher`ツールによって生成されます。
1. `gh pr view --json ...`を使用してPRデータ（メタデータとレビューコメント）を取得します。
2. 生のJSONレスポンスを解析します。
3. レビューコメントを反復処理し、各フィードバックの要約、分析、ファイルパス、行番号、提案されたdiffを抽出します。
4. CodeRabbitのレビュー本文にあるヘッダー（例：「Actionable comments posted」、「Nitpick comments」）に基づいて各コメントを分類します。
5. 静的テンプレートに動的なPRコンテキストと構造化された`<review_comments>`ブロックを埋め込み、最終的なプロンプト文字列を組み立てます。
6. ルールベースの分析とカウントを通じて、`<comment_metadata>`と`<coderabbit_review_summary>`にある構造化メタデータを生成します。

このLLMフリーで決定論的なプロセスは、一貫性、速度、予測可能性を保証し、その後のAI駆動の分析のための信頼できる基盤を提供します。
