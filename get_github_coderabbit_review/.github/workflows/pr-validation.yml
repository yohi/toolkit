name: PR Validation - Essential Tests

on:
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'get_github_coderabbit_review/**'
  push:
    branches: [ main, master, develop ]
    paths:
      - 'get_github_coderabbit_review/**'

jobs:
  essential-tests:
    name: Essential Tests (PR2 & PR38)
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: get_github_coderabbit_review
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # 基本的な依存関係のみインストール（テスト実行に必要な最小限）
        pip install pytest unittest-xml-reporting
        
    - name: Verify test structure
      run: |
        echo "📁 Project structure verification"
        ls -la
        echo "📁 Tests directory structure"
        ls -la tests/
        echo "📁 PR2 test files"
        ls -la tests/pr2/
        echo "📁 PR38 test files"  
        ls -la tests/pr38/
        
    - name: Run Essential Tests
      run: |
        cd tests
        echo "🚀 Starting Essential Tests (GitHub Actions)"
        echo "   Running PR2 and PR38 mock-based output validation tests"
        python run_essential_tests.py
        
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: |
          get_github_coderabbit_review/tests/*.log
          get_github_coderabbit_review/tests/**/test_*.log
        retention-days: 5
        
    - name: Test summary
      if: always()
      run: |
        echo "## 📊 Essential Tests Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Tests Executed:" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ PR38モック化テスト（期待値との比較）" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ PR2モック化テスト（出力生成確認）" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Features:" >> $GITHUB_STEP_SUMMARY
        echo "- 🚫 GitHub認証不要" >> $GITHUB_STEP_SUMMARY
        echo "- 🔄 モック化されたGitHub APIレスポンス使用" >> $GITHUB_STEP_SUMMARY
        echo "- ⚡ 高速実行（essentialテストのみ）" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All tests completed successfully! 🎉" >> $GITHUB_STEP_SUMMARY