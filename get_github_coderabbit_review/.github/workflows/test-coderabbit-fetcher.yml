name: ğŸ§ª CodeRabbit Fetcher Tests

on:
  push:
    paths:
      - "get_github_coderabbit_review/**"
      - "!get_github_coderabbit_review/**.md"
      - "!get_github_coderabbit_review/docs/**"
      - "!get_github_coderabbit_review/examples/**"
    branches: [main, develop, "task-*", "feature-*"]
  pull_request:
    paths:
      - "get_github_coderabbit_review/**"
      - "!get_github_coderabbit_review/**.md"
      - "!get_github_coderabbit_review/docs/**"
      - "!get_github_coderabbit_review/examples/**"
    branches: [main, develop]

env:
  # Pythonè¨­å®š
  PYTHON_VERSION: "3.11"
  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
  PROJECT_DIR: get_github_coderabbit_review
  # ãƒ†ã‚¹ãƒˆè¨­å®š
  PYTHONPATH: ${{ github.workspace }}/get_github_coderabbit_review
  # CIç’°å¢ƒã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¤º
  CI: true

jobs:
  # ğŸ” ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ¤œçŸ¥ã‚¸ãƒ§ãƒ–
  detect-changes:
    name: ğŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      core-changed: ${{ steps.changes.outputs.core }}
      tests-changed: ${{ steps.changes.outputs.tests }}
      config-changed: ${{ steps.changes.outputs.config }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ” Check for changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            core:
              - 'get_github_coderabbit_review/coderabbit_fetcher/**'
              - 'get_github_coderabbit_review/pyproject.toml'
              - 'get_github_coderabbit_review/uv.lock'
            tests:
              - 'get_github_coderabbit_review/tests/**'
            config:
              - '.github/workflows/**'
              - 'get_github_coderabbit_review/Makefile'

  # ğŸ§ª å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¸ãƒ§ãƒ–
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.core-changed == 'true' || needs.detect-changes.outputs.tests-changed == 'true'
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
        os: [ubuntu-latest]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: ğŸ“¦ Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: ğŸ”§ Install dependencies
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          uv sync --dev
          uv pip install pytest pytest-cov pytest-xdist

      - name: ğŸ§ª Run unit tests
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          uv run python tests/test_runner.py --type unit --verbosity 2

      - name: ğŸ“Š Generate coverage report
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          uv run python -m pytest tests/unit/ --cov=coderabbit_fetcher --cov-report=xml --cov-report=term-missing

      - name: ğŸ“ˆ Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ${{ env.PROJECT_DIR }}/coverage.xml
          flags: unit-tests
          name: unit-tests-${{ matrix.python-version }}

  # ğŸ”— çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¸ãƒ§ãƒ–
  integration-tests:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.core-changed == 'true' || needs.detect-changes.outputs.tests-changed == 'true'

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: ğŸ”§ Install dependencies
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          uv sync --dev

      - name: ğŸ”— Run integration tests
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          uv run python tests/test_runner.py --type integration --verbosity 2

  # ğŸ¯ Essential Testsï¼ˆPRå›ºæœ‰ãƒ†ã‚¹ãƒˆï¼‰
  essential-tests:
    name: ğŸ¯ Essential Tests (PR38/PR2)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.core-changed == 'true' || needs.detect-changes.outputs.tests-changed == 'true'

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: ğŸ”§ Install dependencies
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          uv sync --dev

      - name: ğŸ¯ Run essential tests (ãƒ¢ãƒƒã‚¯åŒ–)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          uv run python tests/run_essential_tests.py

      - name: ğŸ“‹ Validate PR38 mock test
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "ğŸ” PR38ãƒ¢ãƒƒã‚¯åŒ–ãƒ†ã‚¹ãƒˆå€‹åˆ¥å®Ÿè¡Œ"
          uv run python tests/pr38/test_pr38_final.py

      - name: ğŸ“‹ Validate PR2 mock test
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "ğŸ” PR2ãƒ¢ãƒƒã‚¯åŒ–ãƒ†ã‚¹ãƒˆå€‹åˆ¥å®Ÿè¡Œ"
          uv run python tests/pr2/test_pr2_quiet_mode.py

  # âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¸ãƒ§ãƒ–
  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, unit-tests]
    if: needs.detect-changes.outputs.core-changed == 'true'

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: ğŸ”§ Install dependencies
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          uv sync --dev

      - name: âš¡ Run performance tests
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          uv run python tests/test_runner.py --type performance --verbosity 2

  # ğŸ” ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ã‚¸ãƒ§ãƒ–
  code-quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.core-changed == 'true'

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: ğŸ”§ Install dependencies
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          uv sync --dev
          uv pip install ruff mypy black isort

      - name: ğŸ” Run linting (ruff)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          uv run ruff check coderabbit_fetcher/

      - name: ğŸ¨ Check code formatting (black)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          uv run black --check coderabbit_fetcher/

      - name: ğŸ”¢ Check import sorting (isort)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          uv run isort --check-only coderabbit_fetcher/

      - name: ğŸ·ï¸ Run type checking (mypy)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          uv run mypy coderabbit_fetcher/
        continue-on-error: true # mypy ã‚¨ãƒ©ãƒ¼ã¯è­¦å‘Šã¨ã—ã¦æ‰±ã†

  # ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ–
  test-summary:
    name: ğŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs:
      [
        detect-changes,
        unit-tests,
        integration-tests,
        essential-tests,
        performance-tests,
        code-quality,
      ]
    if: always() && (needs.detect-changes.outputs.core-changed == 'true' || needs.detect-changes.outputs.tests-changed == 'true')

    steps:
      - name: ğŸ“Š Summarize test results
        run: |
          echo "## ğŸ§ª CodeRabbit Fetcher Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Test Status Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ª Unit Tests | ${{ needs.unit-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”— Integration Tests | ${{ needs.integration-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¯ Essential Tests | ${{ needs.essential-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âš¡ Performance Tests | ${{ needs.performance-tests.result == 'success' && 'âœ… Passed' || needs.performance-tests.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Code Quality | ${{ needs.code-quality.result == 'success' && 'âœ… Passed' || needs.code-quality.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ” Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Core Changes**: ${{ needs.detect-changes.outputs.core-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Changes**: ${{ needs.detect-changes.outputs.tests-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Config Changes**: ${{ needs.detect-changes.outputs.config-changed }}" >> $GITHUB_STEP_SUMMARY

      - name: âœ… Mark as success
        if: needs.unit-tests.result == 'success' && needs.integration-tests.result == 'success' && needs.essential-tests.result == 'success'
        run: |
          echo "ğŸ‰ All critical tests passed!"
          echo "âœ… CodeRabbit Fetcher is ready for deployment"

      - name: âŒ Mark as failure
        if: needs.unit-tests.result == 'failure' || needs.integration-tests.result == 'failure' || needs.essential-tests.result == 'failure'
        run: |
          echo "âŒ Critical tests failed!"
          echo "ğŸ”§ Please fix the failing tests before merging"
          exit 1
