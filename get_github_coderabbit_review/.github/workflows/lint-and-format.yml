name: ğŸ¨ Code Linting & Formatting

on:
  push:
    paths:
      - "get_github_coderabbit_review/**/*.py"
      - "get_github_coderabbit_review/pyproject.toml"
    branches: [main, develop, "task-*", "feature-*"]
  pull_request:
    paths:
      - "get_github_coderabbit_review/**/*.py"
      - "get_github_coderabbit_review/pyproject.toml"
    branches: [main, develop]

env:
  PROJECT_DIR: get_github_coderabbit_review
  PYTHON_VERSION: "3.11"

jobs:
  # ğŸ¨ ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼†ãƒªãƒ³ãƒˆ
  lint-and-format:
    name: ğŸ¨ Lint & Format
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: ğŸ”§ Install dependencies
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          uv sync --dev
          uv pip install ruff mypy black isort

      - name: ğŸ” Run ruff linting
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "ğŸ” Running ruff linting..."
          uv run ruff check coderabbit_fetcher/ --output-format=github

      - name: ğŸ¨ Check code formatting with black
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "ğŸ¨ Checking code formatting..."
          uv run black --check --diff coderabbit_fetcher/

      - name: ğŸ”¢ Check import sorting with isort
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "ğŸ”¢ Checking import sorting..."
          uv run isort --check-only --diff coderabbit_fetcher/

      - name: ğŸ·ï¸ Run mypy type checking
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "ğŸ·ï¸ Running type checking..."
          uv run mypy coderabbit_fetcher/ --show-error-codes
        continue-on-error: true

      - name: ğŸ“Š Generate lint summary
        if: always()
        run: |
          echo "## ğŸ¨ Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Ruff | ${{ job.steps.ruff.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | Code linting and style checks |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¨ Black | ${{ job.steps.black.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | Code formatting validation |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”¢ isort | ${{ job.steps.isort.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | Import sorting validation |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ·ï¸ mypy | ${{ job.steps.mypy.outcome == 'success' && 'âœ… Passed' || 'âš ï¸ Warning' }} | Type checking (non-blocking) |" >> $GITHUB_STEP_SUMMARY

  # ğŸ”§ è‡ªå‹•ä¿®æ­£ï¼ˆãƒ—ãƒƒã‚·ãƒ¥æ™‚ã®ã¿ï¼‰
  auto-fix:
    name: ğŸ”§ Auto-fix Formatting
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    needs: lint-and-format

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: ğŸ”§ Install dependencies
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          uv sync --dev
          uv pip install ruff black isort

      - name: ğŸ¨ Auto-format with black
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          uv run black coderabbit_fetcher/

      - name: ğŸ”¢ Auto-sort imports with isort
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          uv run isort coderabbit_fetcher/

      - name: ğŸ” Auto-fix with ruff
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          uv run ruff check coderabbit_fetcher/ --fix

      - name: ğŸ“¤ Commit auto-fixes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ”§ Auto-fix: Apply code formatting and linting fixes"
            git push
          fi
